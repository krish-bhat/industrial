<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Campus Calendar – MySQL Backend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f3f4f6;
      --bg-card: #ffffff;
      --border-soft: #e5e7eb;
      --border-strong: #d1d5db;
      --text-main: #111827;
      --text-muted: #6b7280;
      --primary: #2563eb;
      --primary-soft: #eff6ff;
      --accent: #4b5563;

      --event: #2563eb;
      --academic: #7c3aed;
      --sport: #059669;
      --closure: #ef4444;
      --parking: #f59e0b;
      --weather: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .page {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0 0 4px;
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
    }

    h1 span.sub {
      font-size: 0.875rem;
      font-weight: 400;
      color: var(--text-muted);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .badge-db {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-size: 0.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #fff;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .btn:hover { background: #f9fafb; }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .layout { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.04);
    }

    .card-inner { padding: 14px 18px 16px; }

    .stats-row {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      font-size: 0.8rem;
      align-items: center;
      margin-top: 10px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
    }

    .dot--event   { background: var(--event); }
    .dot--academic{ background: var(--academic); }
    .dot--sport   { background: var(--sport); }
    .dot--closure { background: var(--closure); }
    .dot--parking { background: var(--parking); }
    .dot--weather { background: var(--weather); }

    .cal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .today-label {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .month-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }

    select {
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #fff;
    }

    .nav-btn {
      border-radius: 999px;
      width: 26px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border-soft);
      background: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .nav-btn:hover { background: #f9fafb; }

    .view-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .view-toggle span {
      padding: 3px 9px;
      border-radius: 999px;
    }

    .view-toggle span.active {
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 500;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      padding: 4px 6px 0;
      margin: 0;
      list-style: none;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .weekdays li {
      text-align: center;
      padding-bottom: 4px;
    }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      padding: 4px 6px 8px;
    }

    .day-cell {
      position: relative;
      min-height: 74px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      padding: 6px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease;
    }

    .day-cell:hover {
      background: #f3f4ff;
      border-color: #c7d2fe;
      box-shadow: 0 4px 10px rgba(129, 140, 248, 0.25);
    }

    .day-cell.empty {
      background: transparent;
      border-style: dashed;
      border-color: transparent;
      cursor: default;
      box-shadow: none;
    }

    .day-cell.selected {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary-soft), 0 10px 24px rgba(37, 99, 235, 0.25);
      background: #eef2ff;
    }

    .day-number {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--accent);
    }

    .dot-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .dot-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid var(--border-soft);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .day-summary {
      margin-top: 2px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .detail-title {
      font-weight: 600;
      font-size: 1rem;
    }

    .detail-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .detail-datekey {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .detail-scroll {
      max-height: 320px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .detail-section { margin-bottom: 10px; }

    .detail-section h4 {
      margin: 10px 0 4px;
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .detail-section h4 .dot {
      width: 9px;
      height: 9px;
    }

    .item-card {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      background: #f9fafb;
      margin-bottom: 4px;
      font-size: 0.8rem;
    }

    .item-title {
      font-weight: 500;
      margin-bottom: 1px;
    }

    .item-sub {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .weather-line {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .tag-tools {
      margin-top: 10px;
      border-top: 1px solid var(--border-soft);
      padding-top: 8px;
    }

    .tag-tools h4 {
      font-size: 0.85rem;
      margin: 0 0 6px;
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .tag-row input {
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      min-width: 120px;
    }

    .tag-row input[type="date"] {
      padding: 3px 8px;
    }

    .tag-row button {
      font-size: 0.78rem;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #fff;
      cursor: pointer;
    }

    .tag-row button.primary {
      border-color: var(--primary);
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 500;
    }

    .tag-row button:hover { background: #f3f4f6; }

    .filter-row {
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .filter-row select { margin-top: 4px; }

    .text-danger { color: #b91c1c; }

    /* ====== NEW: Loading overlay ====== */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-box {
      padding: 12px 16px;
      border-radius: 12px;
      background: white;
      border: 1px solid var(--border-soft);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .spinner {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid #e5e7eb;
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- NEW: global loading overlay -->
  <div id="globalLoading" class="loading-overlay">
    <div class="loading-box">
      <div class="spinner"></div>
      <div>Loading from MySQL…</div>
    </div>
  </div>

  <div class="page">
    <div class="top-bar">
      <div>
        <h1>
          Campus Calendar
          <span class="sub">– MySQL backend</span>
        </h1>
        <div class="badge-db">
          Backed by your <strong>transportation</strong> MySQL database.
        </div>
      </div>
      <button id="reloadBtn" class="btn" type="button">
        ⟳ Reload from DB
      </button>
    </div>

    <div class="card" style="margin-bottom: 14px;">
      <div class="card-inner">
        <div id="statsLine" class="stats-row">
          Loaded: <span class="text-danger">could not load stats from MySQL (check backend).</span>
        </div>
        <div class="legend" aria-label="Category legend">
          <span class="legend-item"><span class="dot dot--event"></span> Events</span>
          <span class="legend-item"><span class="dot dot--academic"></span> Academic calendar</span>
          <span class="legend-item"><span class="dot dot--sport"></span> Sports</span>
          <span class="legend-item"><span class="dot dot--closure"></span> Closures</span>
          <span class="legend-item"><span class="dot dot--parking"></span> Parking / Occupancy</span>
          <span class="legend-item"><span class="dot dot--weather"></span> Weather</span>
        </div>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: calendar -->
      <div class="card">
        <div class="card-inner">
          <div class="cal-header">
            <div class="today-label">Today</div>
            <div class="month-controls">
              <button id="prevMonth" class="nav-btn" type="button">‹</button>
              <select id="monthSelect"></select>
              <select id="yearSelect"></select>
              <button id="nextMonth" class="nav-btn" type="button">›</button>
            </div>
            <div class="view-toggle">
              <span class="active">Month</span>
            </div>
          </div>

          <ul class="weekdays">
            <li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li><li>Sun</li>
          </ul>

          <div id="monthGrid" class="month-grid"></div>
        </div>
      </div>

      <!-- RIGHT: details -->
      <div class="card">
        <div class="card-inner">
          <div class="detail-header">
            <div>
              <div id="detailTitle" class="detail-title">Select a date</div>
              <div id="detailSub" class="detail-sub">
                Click a day in the calendar to see events, sports, closures, parking, weather, and academic info.
              </div>
            </div>
          </div>
          <div id="detailDateKey" class="detail-datekey"></div>
          <div id="detailScroll" class="detail-scroll"></div>

          <div class="tag-tools">
            <h4>Add custom tag to date range (frontend only, saved in this browser)</h4>
            <div class="tag-row">
              <input id="customTagLabel" placeholder="Tag label (e.g. Finals Week)" />
              <input id="customTagName" placeholder="Event name (optional)" />
              <input id="customTagDesc" placeholder="Description / notes (optional)" />
              <!-- changed to calendar pickers -->
              <input id="customTagStart" type="date" />
              <input id="customTagEnd" type="date" />
              <button id="addCustomTagBtn" class="primary" type="button">Add tag to range</button>
              <button id="removeCustomTagBtn" type="button">Remove tag from range</button>
            </div>
            <div class="filter-row">
              <div>Filter by tag (built-in or custom)</div>
              <select id="tagFilterSelect">
                <option value="all">All dates</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /layout -->
  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = "https://industrial-production.up.railway.app";

    // ====== STATE ======
    // customTags: Map<dateKeyString, Array<{label, name, desc}>>
    const state = {
      monthData: new Map(),
      customTags: new Map(),
      selectedDateKey: null,
      year: 2020,
      month: 5, // May 2020
    };

    // ====== LOADING OVERLAY HELPERS ======
    let loadingCount = 0;

    function pushLoading() {
      loadingCount++;
      const overlay = document.getElementById("globalLoading");
      if (overlay) overlay.classList.add("active");
    }

    function popLoading() {
      if (loadingCount > 0) loadingCount--;
      if (loadingCount === 0) {
        const overlay = document.getElementById("globalLoading");
        if (overlay) overlay.classList.remove("active");
      }
    }

    // ====== HELPERS ======
    function formatDateLabel(isoDate) {
      if (!isoDate) return "";
      const d = new Date(isoDate);
      if (Number.isNaN(d.getTime())) return isoDate;
      return d.toLocaleDateString(undefined, {
        year: "numeric",
        month: "long",
        day: "numeric"
      });
    }

    function getCountsForDay(day) {
      const counts = {
        events: 0,
        academic: 0,
        sports: 0,
        closures: 0,
        parking: 0,
        weather: 0
      };
      if (!day || typeof day !== "object") return counts;

      counts.events   = day.event_count    ?? (Array.isArray(day.events)   ? day.events.length   : 0);
      counts.academic = day.academic_count ?? (Array.isArray(day.academic) ? day.academic.length : 0);
      counts.sports   = day.sport_count    ?? (Array.isArray(day.sports)   ? day.sports.length   : 0);
      counts.closures = day.closure_count  ?? (Array.isArray(day.closures) ? day.closures.length : 0);
      counts.parking  = day.parking_count  ?? day.occupancy_count ?? (Array.isArray(day.occupancy) ? day.occupancy.length : 0);
      counts.weather  = day.weather_count  ?? (day.weather ? 1 : 0);

      return counts;
    }

    function sumCounts(counts) {
      let total = 0;
      for (const k in counts) total += counts[k] || 0;
      return total;
    }

    function getCustomTagsFor(dateKey) {
      const list = state.customTags.get(String(dateKey));
      return list || [];
    }

    // --- persistence for custom tags (localStorage, per browser) ---
    function saveCustomTagsToStorage() {
      try {
        const obj = {};
        for (const [key, value] of state.customTags.entries()) {
          obj[key] = value;
        }
        localStorage.setItem("calendarCustomTags", JSON.stringify(obj));
      } catch (e) {
        console.warn("Could not save custom tags", e);
      }
    }

    function loadCustomTagsFromStorage() {
      try {
        const raw = localStorage.getItem("calendarCustomTags");
        if (!raw) return;
        const obj = JSON.parse(raw);
        const map = new Map();
        Object.keys(obj || {}).forEach((key) => {
          map.set(key, obj[key] || []);
        });
        state.customTags = map;
      } catch (e) {
        console.warn("Could not load custom tags", e);
      }
    }

    function addCustomTagRange(label, name, desc, startKey, endKey) {
      const s = Math.min(startKey, endKey);
      const e = Math.max(startKey, endKey);
      for (let dk = s; dk <= e; dk++) {
        const key = String(dk);
        const list = state.customTags.get(key) || [];
        list.push({ label, name, desc });
        state.customTags.set(key, list);
      }
      saveCustomTagsToStorage();
    }

    function removeCustomTagRange(label, startKey, endKey) {
      const s = Math.min(startKey, endKey);
      const e = Math.max(startKey, endKey);
      for (let dk = s; dk <= e; dk++) {
        const key = String(dk);
        if (!state.customTags.has(key)) continue;
        const filtered = state.customTags
          .get(key)
          .filter(t => t.label !== label);
        if (filtered.length) {
          state.customTags.set(key, filtered);
        } else {
          state.customTags.delete(key);
        }
      }
      saveCustomTagsToStorage();
    }

    // now expecting HTML date value "YYYY-MM-DD"
    function parseDateKeyFromInput(value) {
      if (!value) return null;
      const parts = value.split("-").map(p => parseInt(p.trim(), 10));
      if (parts.length !== 3 || parts.some(isNaN)) return null;
      const [year, month, day] = parts; // HTML date is yyyy-mm-dd
      return year * 10000 + month * 100 + day;
    }

    function formatMonthStats(stats) {
      if (!stats) {
        return 'Loaded: <span class="text-danger">could not load stats from MySQL (check backend).</span>';
      }
      const pieces = [];
      if (stats.events    != null) pieces.push(`${stats.events} events`);
      if (stats.sports    != null) pieces.push(`${stats.sports} sports`);
      if (stats.closures  != null) pieces.push(`${stats.closures} closures`);
      if (stats.occupancy != null) pieces.push(`${stats.occupancy} occupancy rows`);
      if (stats.weather   != null) pieces.push(`${stats.weather} weather rows`);
      if (stats.academic  != null) pieces.push(`${stats.academic} academic rows`);
      return "Loaded: " + pieces.join(", ");
    }

    // ====== FILTER OPTIONS (built-in + custom) ======
    const BUILTIN_FILTERS = [
      { value: "all",         label: "All dates" },
      { value: "has-events",  label: "Days with events" },
      { value: "has-academic",label: "Days with academic" },
      { value: "has-sports",  label: "Days with sports" },
      { value: "has-closures",label: "Days with closures" },
      { value: "has-parking", label: "Days with parking / occupancy" },
      { value: "has-weather", label: "Days with weather" },
    ];

    function setBaseFilterOptions(selectEl, currentValue) {
      selectEl.innerHTML = "";
      BUILTIN_FILTERS.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.value;
        opt.textContent = f.label;
        selectEl.appendChild(opt);
      });
      if (currentValue && BUILTIN_FILTERS.some(f => f.value === currentValue)) {
        selectEl.value = currentValue;
      }
    }

    // ====== RENDER: MONTH GRID ======
    function renderMonthGrid() {
      const grid = document.getElementById("monthGrid");
      grid.innerHTML = "";

      const year = state.year;
      const month = state.month;

      const first = new Date(year, month - 1, 1);
      const startWeekday = (first.getDay() + 6) % 7; // Monday-first

      const daysInMonth = new Date(year, month, 0).getDate();
      const cells = [];

      for (let i = 0; i < startWeekday; i++) cells.push(null);

      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = year * 10000 + month * 100 + day;
        const dayData = state.monthData.get(String(dateKey));
        cells.push({ day, dateKey, dayData });
      }

      const tagFilter = document.getElementById("tagFilterSelect").value;

      for (const cell of cells) {
        const div = document.createElement("div");

        if (!cell) {
          div.className = "day-cell empty";
          grid.appendChild(div);
          continue;
        }

        const { day, dateKey, dayData } = cell;
        const counts = getCountsForDay(dayData);
        const total = sumCounts(counts);
        const customTags = getCustomTagsFor(dateKey);

        // --- filtering ---
        let hide = false;
        if (tagFilter === "has-events"   && !counts.events)   hide = true;
        if (tagFilter === "has-academic" && !counts.academic) hide = true;
        if (tagFilter === "has-sports"   && !counts.sports)   hide = true;
        if (tagFilter === "has-closures" && !counts.closures) hide = true;
        if (tagFilter === "has-parking"  && !counts.parking)  hide = true;
        if (tagFilter === "has-weather"  && !counts.weather)  hide = true;

        if (tagFilter.startsWith("custom:")) {
          const label = tagFilter.slice("custom:".length);
          if (!customTags.some(t => t.label === label)) hide = true;
        }

        if (hide) {
          div.className = "day-cell empty";
          grid.appendChild(div);
          continue;
        }
        // --- end filtering ---

        div.className = "day-cell";
        div.dataset.dateKey = String(dateKey);

        if (String(dateKey) === String(state.selectedDateKey)) {
          div.classList.add("selected");
        }

        const num = document.createElement("div");
        num.className = "day-number";
        num.textContent = day;
        div.appendChild(num);

        const dotRow = document.createElement("div");
        dotRow.className = "dot-row";

        function addDot(label, count, cls) {
          if (!count) return;
          const pill = document.createElement("div");
          pill.className = "dot-pill";
          pill.title = `${label}: ${count}`;
          const dot = document.createElement("span");
          dot.className = "dot " + cls;
          const txt = document.createElement("span");
          txt.textContent = count;
          pill.appendChild(dot);
          pill.appendChild(txt);
          dotRow.appendChild(pill);
        }

        addDot("Events",   counts.events,   "dot--event");
        addDot("Academic", counts.academic, "dot--academic");
        addDot("Sports",   counts.sports,   "dot--sport");
        addDot("Closures", counts.closures, "dot--closure");
        addDot("Parking",  counts.parking,  "dot--parking");
        addDot("Weather",  counts.weather,  "dot--weather");

        if (dotRow.children.length) div.appendChild(dotRow);

        const summary = document.createElement("div");
        summary.className = "day-summary";
        const parts = [];
        if (total) parts.push(total + " items");

        // distinct labels for that date
        const labelSet = new Set(customTags.map(t => t.label));
        const labelList = Array.from(labelSet);
        if (labelList.length) parts.push(labelList.join(", "));

        summary.textContent = parts.join(" · ");
        div.appendChild(summary);

        div.addEventListener("click", () => {
          state.selectedDateKey = String(dateKey);
          renderMonthGrid();
          loadDateDetails(dateKey);
        });

        grid.appendChild(div);
      }
    }

    // ====== DETAIL PANEL ======
    function renderDetailPlaceholder() {
      document.getElementById("detailTitle").textContent = "Select a date";
      document.getElementById("detailSub").textContent =
        "Click a day in the calendar to see events, sports, closures, parking, weather, and academic info.";
      document.getElementById("detailDateKey").textContent = "";
      document.getElementById("detailScroll").innerHTML = "";
    }

    function renderDetail(dateKey, payload) {
      const detailTitle = document.getElementById("detailTitle");
      const detailSub = document.getElementById("detailSub");
      const detailDateKey = document.getElementById("detailDateKey");
      const scroll = document.getElementById("detailScroll");

      const dateLabel = formatDateLabel(payload.date || payload.date_iso);

      detailTitle.textContent = dateLabel || "Details";
      detailSub.textContent = "";
      detailDateKey.textContent = "date_key: " + dateKey;
      scroll.innerHTML = "";

      function makeSection(title, cls, items) {
        if (!items || !items.length) return;

        const sec = document.createElement("div");
        sec.className = "detail-section";

        const h = document.createElement("h4");
        const dot = document.createElement("span");
        dot.className = "dot " + cls;
        h.appendChild(dot);
        const span = document.createElement("span");
        span.textContent = " " + title + " (" + items.length + ")";
        h.appendChild(span);
        sec.appendChild(h);

        for (const it of items) {
          const card = document.createElement("div");
          card.className = "item-card";
          const t = document.createElement("div");
          t.className = "item-title";
          t.textContent = it.title || it.event_name || it.sport || "Untitled";
          const s = document.createElement("div");
          s.className = "item-sub";
          s.textContent =
            it.location ||
            it.stadium ||
            it.entity_name ||
            it.facility_name ||
            "";
          card.appendChild(t);
          card.appendChild(s);
          sec.appendChild(card);
        }

        scroll.appendChild(sec);
      }

      makeSection("Events", "dot--event",    payload.events   || payload.event_list);
      makeSection("Academic", "dot--academic", payload.academic || payload.academic_calendar);
      makeSection("Sports", "dot--sport",    payload.sports);
      makeSection("Closures", "dot--closure",payload.closures);
      makeSection("Parking / Occupancy", "dot--parking", payload.occupancy || payload.parking);

      if (payload.weather) {
        const sec = document.createElement("div");
        sec.className = "detail-section";
        const h = document.createElement("h4");
        const dot = document.createElement("span");
        dot.className = "dot dot--weather";
        h.appendChild(dot);
        const span = document.createElement("span");
        span.textContent = " Weather";
        h.appendChild(span);
        sec.appendChild(h);

        const w = payload.weather;
        const line = document.createElement("div");
        line.className = "weather-line";
        const pieces = [];
        if (w.tavg != null) pieces.push(`Tavg ${w.tavg}°F`);
        if (w.tmin != null && w.tmax != null) pieces.push(`(min ${w.tmin}°F / max ${w.tmax}°F)`);
        if (w.prcp != null) pieces.push(`P ${w.prcp}"`);
        if (w.snow != null) pieces.push(`Snow ${w.snow}"`);
        line.textContent = pieces.join(", ");
        sec.appendChild(line);

        scroll.appendChild(sec);
      }

      // Custom tags section
      const customTags = getCustomTagsFor(dateKey);
      if (customTags.length) {
        const sec = document.createElement("div");
        sec.className = "detail-section";

        const h = document.createElement("h4");
        const dot = document.createElement("span");
        dot.className = "dot dot--event";
        h.appendChild(dot);
        const span = document.createElement("span");
        span.textContent = " Custom tags (saved in this browser)";
        h.appendChild(span);
        sec.appendChild(h);

        customTags.forEach(tag => {
          const card = document.createElement("div");
          card.className = "item-card";

          const t = document.createElement("div");
          t.className = "item-title";
          t.textContent = tag.name
            ? `${tag.label} — ${tag.name}`
            : tag.label;

          const s = document.createElement("div");
          s.className = "item-sub";
          s.textContent = tag.desc || "";
          card.appendChild(t);
          card.appendChild(s);
          sec.appendChild(card);
        });

        scroll.appendChild(sec);
      }

      if (!scroll.children.length) {
        const p = document.createElement("div");
        p.className = "detail-section";
        p.textContent = "No data for this date.";
        scroll.appendChild(p);
      }
    }

    // ====== BACKEND CALLS ======
    async function loadStats() {
      pushLoading();
      try {
        const res = await fetch(
          `${API_BASE}/api/stats?ts=${Date.now()}`,
          { cache: "no-store" }
        );
        if (!res.ok) throw new Error("HTTP " + res.status);

        const stats = await res.json();
        document.getElementById("statsLine").innerHTML = formatMonthStats(stats);
      } catch (err) {
        console.error("Failed to load stats", err);
        document.getElementById("statsLine").innerHTML =
          'Loaded: <span class="text-danger">could not load stats from MySQL (check backend).</span>';
      } finally {
        popLoading();
      }
    }

    async function loadMonth(year, month) {
      pushLoading();
      try {
        const url = `${API_BASE}/api/month?year=${year}&month=${month}&ts=${Date.now()}`;
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        state.monthData.clear();

        const days = data.days || data || [];
        for (const d of days) {
          const dk = String(d.date_key || d.dateKey);
          if (!dk) continue;
          state.monthData.set(dk, d);
        }

        renderMonthGrid();
      } catch (err) {
        console.error("Failed to load month", err);
        alert("Failed to load month data from server.");
      } finally {
        popLoading();
      }
    }

    async function loadDateDetails(dateKey) {
      pushLoading();
      try {
        const res = await fetch(`${API_BASE}/api/date/${dateKey}?ts=${Date.now()}`, {
          cache: "no-store",
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const payload = await res.json();
        renderDetail(dateKey, payload);
      } catch (err) {
        console.error("Failed to load date detail", err);
        alert("Failed to load date detail from server.");
      } finally {
        popLoading();
      }
    }

    // ====== UI WIRING ======
    function initMonthYearSelectors() {
      const monthSel = document.getElementById("monthSelect");
      const yearSel = document.getElementById("yearSelect");

      const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

      monthSel.innerHTML = "";
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = monthNames[m-1];
        monthSel.appendChild(opt);
      }

      yearSel.innerHTML = "";
      for (let y = 2020; y <= 2024; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        yearSel.appendChild(opt);
      }

      monthSel.value = state.month;
      yearSel.value = state.year;

      monthSel.addEventListener("change", () => {
        state.month = parseInt(monthSel.value, 10);
        loadMonth(state.year, state.month);
        renderDetailPlaceholder();
      });

      yearSel.addEventListener("change", () => {
        state.year = parseInt(yearSel.value, 10);
        loadMonth(state.year, state.month);
        renderDetailPlaceholder();
      });

      document.getElementById("prevMonth").addEventListener("click", () => {
        let m = state.month - 1;
        let y = state.year;
        if (m < 1) { m = 12; y--; }
        if (y < 2020) { y = 2020; m = 1; }
        state.month = m;
        state.year = y;
        monthSel.value = m;
        yearSel.value = y;
        loadMonth(y, m);
        renderDetailPlaceholder();
      });

      document.getElementById("nextMonth").addEventListener("click", () => {
        let m = state.month + 1;
        let y = state.year;
        if (m > 12) { m = 1; y++; }
        if (y > 2024) { y = 2024; m = 12; }
        state.month = m;
        state.year = y;
        monthSel.value = m;
        yearSel.value = y;
        loadMonth(y, m);
        renderDetailPlaceholder();
      });
    }

    function initCustomTagUI() {
      const labelInput = document.getElementById("customTagLabel");
      const nameInput  = document.getElementById("customTagName");
      const descInput  = document.getElementById("customTagDesc");
      const startInput = document.getElementById("customTagStart");
      const endInput   = document.getElementById("customTagEnd");
      const addBtn     = document.getElementById("addCustomTagBtn");
      const rmBtn      = document.getElementById("removeCustomTagBtn");
      const filterSel  = document.getElementById("tagFilterSelect");

      function refreshFilterOptions() {
        const current = filterSel.value;

        // reset built-in options first
        setBaseFilterOptions(filterSel, current);

        // add custom labels
        const allLabels = new Set();
        for (const list of state.customTags.values()) {
          for (const tag of list) allLabels.add(tag.label);
        }
        for (const lab of allLabels) {
          const opt = document.createElement("option");
          opt.value = "custom:" + lab;
          opt.textContent = `Custom – ${lab}`;
          filterSel.appendChild(opt);
        }

        // restore selection if still valid
        const possibleValues = new Set(
          BUILTIN_FILTERS.map(f => f.value)
        );
        for (const lab of allLabels) {
          possibleValues.add("custom:" + lab);
        }

        if (possibleValues.has(current)) {
          filterSel.value = current;
        }
      }

      filterSel.addEventListener("change", () => {
        renderMonthGrid();
      });

      addBtn.addEventListener("click", () => {
        const label = labelInput.value.trim();
        const name  = nameInput.value.trim();
        const desc  = descInput.value.trim();
        const s = parseDateKeyFromInput(startInput.value);
        const e = parseDateKeyFromInput(endInput.value);
        if (!label || !s || !e) {
          alert("Please provide label and valid start/end date (using the date pickers).");
          return;
        }
        addCustomTagRange(label, name, desc, s, e);
        refreshFilterOptions();
        renderMonthGrid();
      });

      rmBtn.addEventListener("click", () => {
        const label = labelInput.value.trim();
        const s = parseDateKeyFromInput(startInput.value);
        const e = parseDateKeyFromInput(endInput.value);
        if (!label || !s || !e) {
          alert("Please provide label and valid start/end date (using the date pickers).");
          return;
        }
        removeCustomTagRange(label, s, e);
        refreshFilterOptions();
        renderMonthGrid();
      });

      // initial population of filter
      refreshFilterOptions();
    }

    function initReloadButton() {
      document.getElementById("reloadBtn").addEventListener("click", () => {
        loadStats();
        loadMonth(state.year, state.month);
        renderDetailPlaceholder();
      });
    }

    // ====== INIT ======
    (function init() {
      loadCustomTagsFromStorage();   // restore saved tags (per browser)
      initMonthYearSelectors();
      initCustomTagUI();
      initReloadButton();
      renderDetailPlaceholder();
      loadStats();
      loadMonth(state.year, state.month); // May 2020
    })();
  </script>
</body>
</html>
